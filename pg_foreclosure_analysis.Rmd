---
title: "Foreclosure Data Analysis"
author: "Jasper Evans, Krehl Kasayan, Paul Kiefer, Pablo Suarez"
date: "2024-20-2024"
output: html_document
---

# Prince George's County Maryland Foreclosure Analysis

We will use Prince George's County's foreclosure dataset as the core of our project (https://data.princegeorgescountymd.gov/Urban-Planning/County-Foreclosures/mnie-hrv7/about_data). The dataset is maintained by the Prince George's County planning department and lists foreclosures by address between 2009 and 2024. The dataset has imperfections, including some apparent duplicate records.

## Data Setup

Load libraries.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(scipen=999)
##install.packages("ggrepel")
##install.packages('ggthemes')
library(tidyverse)
library(lubridate)
library(janitor)
library(ggthemes)
library(tidycensus)
library(ggplot2)
library(ggrepel)
library(tigris)
library(sf)
library(ggmap)
```


The foreclosure dataset contains 71676 rows and 10 columns, including the street number, street name, city, state and zip code of each foreclosure. For our purposes, only the components of the address will be needed. 

```{r}
# Read in the initial dataset, setting a guess_max limit to improve the accuracy of the data types assigned to each column.
foreclosure_pg <- read_csv("datasets/pg_foreclosures.csv", guess_max = 71676)
```
Because we will need to group foreclosure records by census tract, we first need to determine the census tract identification number for each address in the original dataset. The geolocation service Geocodio (https://www.geocod.io/) provides two options: An API or a straightforward upload process. The Geocodio API instructions were too convoluted for our specific task, so instead, we uploaded the addresses from the original dataset, producing a new dataset that includes each address and the corresponding census tract identification number, among other geolocation datapoints.

```{r}
#Read in the geocoded address dataset.
foreclosure_pg_census_tracts <- read_csv("datasets/pg_foreclosure_tract_geocodio.csv", guess_max = 71676) |>
  clean_names()
```
For our eventual predictive analysis, we want a sample of at least 100 census tracts to improve the accuracy of our model. We can use the unique() function to count the number of unique tract codes in the pg_foreclosure_census_tracts dataframe.

```{r}
tracts_unique <- length(unique(foreclosure_pg_census_tracts$census_tract_code))

print(tracts_unique)
```
While some of those tracts may be erroneous -- in another state, for instance -- we are comfortably above the 100-tract threshhold.

We can now use an inner join to combine the original dataset with the address and tract dataset using the matching values in the "location" columns. We will also need year and year_month columns for future plotting, so we add those here and format them as date type. 

```{r}
# Perform inner join based on the 'location' column.
pg_foreclosures_with_tracts <- inner_join(foreclosure_pg, foreclosure_pg_census_tracts, by = "location")

# Convert "submitteddate" column to date type.
pg_foreclosures_with_tracts$submitteddate <- as.Date(pg_foreclosures_with_tracts$submitteddate, format = "%m/%d/%Y")

# Extract the year and month from "submitteddate".
pg_foreclosures_with_tracts$year <- year(pg_foreclosures_with_tracts$submitteddate)
pg_foreclosures_with_tracts$month <- month(pg_foreclosures_with_tracts$submitteddate)

# Create a year-month column for eventual plotting.
pg_foreclosures_with_tracts$year_month <- as.Date(paste(pg_foreclosures_with_tracts$year, pg_foreclosures_with_tracts$month, "01", sep = "-"), format = "%Y-%m-%d")

# Print the dataset.
print(pg_foreclosures_with_tracts)
```
Unfortunately, the joining process produces tens of thousands of duplicates -- the result of duplicate addresses appearing in the original dataset. For some reason, this problem persists regardless of what type of join we use. 

To remove those duplicates, we need to identify sets of duplicate rows using the values that will match within a set of duplicates: the values in the "street_address", "city.y" and "propertyid" columns. We will also use the "year_month" column to catch duplicate records that vary slightly in the "submitteddate" column -- a decision we make on the assumption that a single property cannot be foreclosed upon more than once in a single month. This step allows us to clean duplicate records that existed in the original dataset as well as those created by the joining process. We will keep only a single record from each matching set.

```{r}
# Order the dataframe by the columns that identify remainins duplicate rows.

pg_foreclosures_with_tracts <- pg_foreclosures_with_tracts[order(pg_foreclosures_with_tracts$propertyid, pg_foreclosures_with_tracts$street_address, pg_foreclosures_with_tracts$city.y, pg_foreclosures_with_tracts$submitteddate), ]

# Keep only the last row from each set of duplicates
pg_foreclosures_filtered <- subset(pg_foreclosures_with_tracts, !duplicated(pg_foreclosures_with_tracts[, c("propertyid", "street_address", "city.y", "submitteddate")], fromLast = TRUE))

# Reset row names if necessary
rownames(pg_foreclosures_filtered) <- NULL
```

Because we need to group by census tract, we now remove any records that are missing a value in the census tract code column. This removed roughly 120 records.

```{r}
# Filter the pg_foreclosures_filtered dataset to remove rows with missing values in the census_tract_code column. 
pg_foreclosures_filtered <- pg_foreclosures_filtered[!is.na(pg_foreclosures_filtered$census_tract_code), ]
```

We can clean up our dataset by removing extraneous columns created by Geocodio.
```{r}
# Remove unnecessary columns with the select() function.
pg_foreclosures_filtered <- select(pg_foreclosures_filtered, -accuracy_score, -accuracy_type, -source, -full_fips_block, -metro_micro_statistical_area_name,-metro_micro_statistical_area_code, -metro_micro_statistical_area_type, -combined_statistical_area_name, -metropolitan_division_area_name, -metropolitan_division_area_code, -addressoccupied, -full_fips_block)
```

Next, we remove all records for addresses outside of Maryland. 

```{r}
# Remove non-Maryland addresses from the dataset.
pg_foreclosures_filtered <- pg_foreclosures_filtered |>
  filter(state.x == "MD")
```

With only Maryland addresses remaining, we can group by census tract identification code and use the joining process with American Community Survey data to continue the cleaning process later.

```{r}
# Group by census_tract_code and summarize to count the number of foreclosures per tract.
pg_foreclosures_per_tract <- pg_foreclosures_filtered |>
  group_by(census_tract_code) |>
  summarize(foreclosure_count = n())
```


The independent variables we will need for our predictive model will come from the American Community Survey (ACS). To access ACS data, we use a Census API key -- stored locally for security. 

As a building block for per capita calculations, we need the population of each census tract as of the 2016-2020 ACS. Because the variable codes for the 2020 Census are harder to search, we will rely on the ACS instead of the Census. 

The B01003_001 variable represents total population.
```{r}
#Grab population by Maryland tract using American Community Survey API.
md_tract_pop_2020 <- get_acs(geography = "tract",
              variables = c(tract_pop = "B01003_001"),
              state = "MD",
              year = 2020,
              geometry = TRUE)

```
We only need tracts in Prince George's County, so we can use the "NAME" column from the ACS data to filter out tracts in other counties. The ACS data appends the Maryland state identification number (24) and the Prince George's County identification number (033) to the beginning of each tract identification number, so we also need to create a new column for the stand-alone tract identification numbers.

```{r}
# Use the str_detect function and the string "Prince George" to isolate tracts in Prince George's County.
pg_tract_pop_2020 <- md_tract_pop_2020[str_detect(md_tract_pop_2020$NAME, "Prince George"), ]

# Use the gsub function to remove the '24033' prefix from census tract identification numbers and save the results in a new 'tract_number' column. 
pg_tract_pop_2020$tract_number <- gsub('24033', '', pg_tract_pop_2020$GEOID)
```

We can now join the pg_foreclosures_per_tract dataset with the pg_tract_pop_2020 dataset. By using a left join, we filter out foreclosures in tracts that -- according to Geocodio -- are not in Prince George's County. While this eliminated more than 200 records, we are still left with 214 tracts' worth of data for our model.

```{r}
# Left join the pg_tract_pop_2020 data from the ACS with the pg_foreclosures_per_tract dataset.
pg_foreclosures_per_tract <- left_join(pg_tract_pop_2020, pg_foreclosures_per_tract, by=c("tract_number" = "census_tract_code")) |>
  #Rename the "estimate" variable
  rename(tract_pop_2020 = estimate) |>
  #Remove extraneous columns.
  select(-NAME, -variable) |> 
  #Add foreclosures per capita column using 2020 ACS population estimate.
  mutate(foreclosure_pc_2020 = (foreclosure_count/tract_pop_2020)*1000)
```


We will now repeat the process with other ACS variables, starting with median household income. We will use the median household income as of the 2016-2020 ACS as a stand-alone independent variable and use the changes between the 2006-2010, 2011-2015 and 2016-2020 ACS as separate independent variables.

Median household income as of the 2006-2010:
```{r}
#Grab median household income as of the 2006-2010 ACS.
md_medhouseholdincome_2010_tract <- get_acs(geography = "tract", state="MD",
              variables = c(medhouseholdincome_2010 = "B19013_001"),
              year = 2010)

# Use the str_detect function and the string "Prince George" to isolate tracts in Prince George's County.
pg_medhouseholdincome_2010_tract <- md_medhouseholdincome_2010_tract[str_detect(md_medhouseholdincome_2010_tract$NAME, "Prince George"), ]

# Use the gsub function to remove the '24033' prefix from census tract identification numbers and save the results in a new 'tract_number' column. 
pg_medhouseholdincome_2010_tract$tract_number <- gsub('24033', '', pg_medhouseholdincome_2010_tract$GEOID)
```
Median household income as of the 2011-2015 ACS

```{r}
md_medhouseholdincome_2015_tract <- get_acs(geography = "tract", state="MD",
              variables = c(medhouseholdincome_2015 = "B19013_001"),
              year = 2015)

# Use the str_detect function and the string "Prince George" to isolate tracts in Prince George's County.
pg_medhouseholdincome_2015_tract <- md_medhouseholdincome_2015_tract[str_detect(md_medhouseholdincome_2015_tract$NAME, "Prince George"), ]

# Use the gsub function to remove the '24033' prefix from census tract identification numbers and save the results in a new 'tract_number' column. 
pg_medhouseholdincome_2015_tract$tract_number <- gsub('24033', '', pg_medhouseholdincome_2015_tract$GEOID)
              
```
Median household income as of the 2016-2020 ACS:
```{r}
md_medhouseholdincome_2020_tract <- get_acs(geography = "tract", state="MD",
              variables = c(medhouseholdincome_2020= "B19013_001"),
              year = 2020)

# Use the str_detect function and the string "Prince George" to isolate tracts in Prince George's County.
pg_medhouseholdincome_2020_tract <- md_medhouseholdincome_2020_tract[str_detect(md_medhouseholdincome_2020_tract$NAME, "Prince George"), ]

# Use the gsub function to remove the '24033' prefix from census tract identification numbers and save the results in a new 'tract_number' column. 
pg_medhouseholdincome_2020_tract$tract_number <- gsub('24033', '', pg_medhouseholdincome_2020_tract$GEOID)
```

We also need the estimated total number of housing units at the tract level. We will use the three consecutive ACS estimates as a denominator to calculate owner-occupied housing/total number of housing units, and we will use the change between those rates as an independent variable. 

Total housing units as of 2006-2010 ACS:
```{r}
md_total_housing_2010 <- get_acs(geography = "tract",
              variables = c(total_housing_2010 = "B25001_001"),
              state = "MD",
              year = 2010)

# Use the str_detect function and the string "Prince George" to isolate tracts in Prince George's County.
pg_total_housing_2010 <- md_total_housing_2010[str_detect(md_total_housing_2010$NAME, "Prince George"), ]

# Use the gsub function to remove the '24033' prefix from census tract identification numbers and save the results in a new 'tract_number' column. 
pg_total_housing_2010$tract_number <- gsub('24033', '', pg_total_housing_2010$GEOID)
```
Total housing units as of 2011-2015 ACS:
```{r}
md_total_housing_2015 <- get_acs(geography = "tract",
              variables = c(total_housing_2015 = "B25001_001"),
              state = "MD",
              year = 2015)

# Use the str_detect function and the string "Prince George" to isolate tracts in Prince George's County.
pg_total_housing_2015 <- md_total_housing_2015[str_detect(md_total_housing_2015$NAME, "Prince George"), ]

# Use the gsub function to remove the '24033' prefix from census tract identification numbers and save the results in a new 'tract_number' column. 
pg_total_housing_2015$tract_number <- gsub('24033', '', pg_total_housing_2015$GEOID)
```

Total housing units as of 2016-2020 ACS.
```{r}
md_total_housing_2020 <- get_acs(geography = "tract",
              variables = c(total_housing_2020 = "B25001_001"),
              state = "MD",
              year = 2020)

# Use the str_detect function and the string "Prince George" to isolate tracts in Prince George's County.
pg_total_housing_2020 <- md_total_housing_2020[str_detect(md_total_housing_2020$NAME, "Prince George"), ]

# Use the gsub function to remove the '24033' prefix from census tract identification numbers and save the results in a new 'tract_number' column. 
pg_total_housing_2020$tract_number <- gsub('24033', '', pg_total_housing_2020$GEOID)
```

For the numerator in the aforementioned calculation, we also need the number of owner occupied units recorded in three consecutive ACS. 

Owner-occupied housing as of 2006-2010 ACS:
```{r}
md_owner_housing_2010 <- get_acs(geography = "tract",
              variables = c(owner_housing_2015 = "B25003_002"),
              state = "MD",
              year = 2010)

# Use the str_detect function and the string "Prince George" to isolate tracts in Prince George's County.
pg_owner_housing_2010 <- md_owner_housing_2010[str_detect(md_owner_housing_2010$NAME, "Prince George"), ]

# Use the gsub function to remove the '24033' prefix from census tract identification numbers and save the results in a new 'tract_number' column. 
pg_owner_housing_2010$tract_number <- gsub('24033', '', pg_owner_housing_2010$GEOID)
```

Owner-occupied housing as of 2011-2015 ACS:
```{r}
md_owner_housing_2015 <- get_acs(geography = "tract",
              variables = c(owner_housing_2015 = "B25003_002"),
              state = "MD",
              year = 2015)

# Use the str_detect function and the string "Prince George" to isolate tracts in Prince George's County.
pg_owner_housing_2015 <- md_owner_housing_2015[str_detect(md_owner_housing_2015$NAME, "Prince George"), ]

# Use the gsub function to remove the '24033' prefix from census tract identification numbers and save the results in a new 'tract_number' column. 
pg_owner_housing_2015$tract_number <- gsub('24033', '', pg_owner_housing_2015$GEOID)
```

Owner-occupied housing as of 2016-2020 ACS:
```{r}
md_owner_housing_2020 <- get_acs(geography = "tract",
              variables = c(owner_housing_2020 = "B25003_002"),
              state = "MD",
              year = 2020)

# Use the str_detect function and the string "Prince George" to isolate tracts in Prince George's County.
pg_owner_housing_2020 <- md_owner_housing_2020[str_detect(md_owner_housing_2020$NAME, "Prince George"), ]

# Use the gsub function to remove the '24033' prefix from census tract identification numbers and save the results in a new 'tract_number' column. 
pg_owner_housing_2020$tract_number <- gsub('24033', '', pg_owner_housing_2020$GEOID)
```

To calculate the ratio of mortgaged housing units to total housing units over a decade, we will need the ACS estimates for "housing units with a mortgage, contract to purchase, or similar debt."

Mortgaged housing as of 2006-2010 ACS:
```{r}
md_debt_housing_2010 <- get_acs(geography = "tract",
              variables = c(debt_housing_2010 = "B25081_002"),
              state = "MD",
              year = 2010)

# Use the str_detect function and the string "Prince George" to isolate tracts in Prince George's County.
pg_debt_housing_2010 <- md_debt_housing_2010[str_detect(md_debt_housing_2010$NAME, "Prince George"), ]

# Use the gsub function to remove the '24033' prefix from census tract identification numbers and save the results in a new 'tract_number' column. 
pg_debt_housing_2010$tract_number <- gsub('24033', '', pg_debt_housing_2010$GEOID)
```


Mortgaged housing as of 2011-2015 ACS:
```{r}
md_debt_housing_2015 <- get_acs(geography = "tract",
              variables = c(debt_housing_2015 = "B25081_002"),
              state = "MD",
              year = 2015)

# Use the str_detect function and the string "Prince George" to isolate tracts in Prince George's County.
pg_debt_housing_2015 <- md_debt_housing_2015[str_detect(md_debt_housing_2015$NAME, "Prince George"), ]

# Use the gsub function to remove the '24033' prefix from census tract identification numbers and save the results in a new 'tract_number' column. 
pg_debt_housing_2015$tract_number <- gsub('24033', '', pg_debt_housing_2015$GEOID)
```

Mortgaged housing as of the 2016-2020 ACS:
```{r}
md_debt_housing_2020 <- get_acs(geography = "tract",
              variables = c(debt_housing_2020 = "B25081_002"),
              state = "MD",
              year = 2020)

# Use the str_detect function and the string "Prince George" to isolate tracts in Prince George's County.
pg_debt_housing_2020 <- md_debt_housing_2020[str_detect(md_debt_housing_2020$NAME, "Prince George"), ]

# Use the gsub function to remove the '24033' prefix from census tract identification numbers and save the results in a new 'tract_number' column. 
pg_debt_housing_2020$tract_number <- gsub('24033', '', pg_debt_housing_2020$GEOID)
```


While the relationship between age and foreclosure risk is unclear, it will be worthwhile to ascertain whether there is a strong correlation between foreclosure rate per capita and median age at the tract level. For that, we need the median age at the tract level from the 2016-2020 ACS. 
```{r}
md_medage_2020 <- get_acs(geography = "tract",
              variables = c(medage_2020 = "B01002_001"),
              state = "MD",
              year = 2020)

# Use the str_detect function and the string "Prince George" to isolate tracts in Prince George's County.
pg_medage_2020 <- md_medage_2020[str_detect(md_medage_2020$NAME, "Prince George"), ]

# Use the gsub function to remove the '24033' prefix from census tract identification numbers and save the results in a new 'tract_number' column. 
pg_medage_2020$tract_number <- gsub('24033', '', pg_medage_2020$GEOID)
```

The relationship between foreclosure risk and the share of non-Hispanic white people in a given geography is well-documented, with race and ethnicity data standing in for longstanding economic inequalities that often split on racial lines -- particularly in urban and suburban communities like Prince George's County. We will use these datapoints in two ways:


The 2006-2010 ACS estimates for non-Hispanic white population by tract will be used to calculate the change in non-Hispanic white population by tract between 2010 and 2020. 
```{r}
md_nhwhite_2010 <- get_acs(geography = "tract", state="MD",
  variables = c(nhwhite_2010 = "B03002_003E"), year = 2010)

# Use the str_detect function and the string "Prince George" to isolate tracts in Prince George's County.
pg_nhwhite_2010 <- md_nhwhite_2010[str_detect(md_nhwhite_2010$NAME, "Prince George"), ]

# Use the gsub function to remove the '24033' prefix from census tract identification numbers and save the results in a new 'tract_number' column. 
pg_nhwhite_2010$tract_number <- gsub('24033', '', pg_nhwhite_2010$GEOID)
```
The 2016-2020 ACS estimates for non-Hispanic white population by tract will be use to complete the year-over-year percentage change calculation and as a stand-alone independent variable.

```{r}
md_nhwhite_2020 <- get_acs(geography = "tract", state="MD",
  variables = c(nhwhite_2020 = "B03002_003E"), year = 2020)

# Use the str_detect function and the string "Prince George" to isolate tracts in Prince George's County.
pg_nhwhite_2020 <- md_nhwhite_2020[str_detect(md_nhwhite_2020$NAME, "Prince George"), ]

# Use the gsub function to remove the '24033' prefix from census tract identification numbers and save the results in a new 'tract_number' column. 
pg_nhwhite_2020$tract_number <- gsub('24033', '', pg_nhwhite_2020$GEOID)
```

We will use the 2006-2010 ACS estimates of the population with "income in the past 12 months below poverty level" and the 2016-2020 ACS estimates of the same variable for another comparison. Because this number includes all people over the age of 5, it is an imperfect measurement of poverty rate because it includes both children and adults. It is, however, simpler than adding the totals for each age group over the age of 18 and comparing those poverty rates to the share of the population in each tract that falls into each age group.

Number of people (>5 years old) with incomes below poverty level by census tract as of the 2006-2010 ACS:

```{r}
md_poverty_2010 <- get_acs(geography = "tract", state="MD",
  variables = c(poverty_2020 = "B16009_002E"), year = 2010)

# Use the str_detect function and the string "Prince George" to isolate tracts in Prince George's County.
pg_poverty_2010 <- md_poverty_2010[str_detect(md_poverty_2010$NAME, "Prince George"), ]

# Use the gsub function to remove the '24033' prefix from census tract identification numbers and save the results in a new 'tract_number' column. 
pg_poverty_2010$tract_number <- gsub('24033', '', pg_poverty_2010$GEOID)
```


Number of people (>5 years old) with incomes below poverty level by census tract as of the 2016-2020 ACS:

```{r}
md_poverty_2020 <- get_acs(geography = "tract", state="MD",
  variables = c(poverty_2020 = "B16009_002E"), year = 2020)

# Use the str_detect function and the string "Prince George" to isolate tracts in Prince George's County.
pg_poverty_2020 <- md_poverty_2020[str_detect(md_poverty_2020$NAME, "Prince George"), ]

# Use the gsub function to remove the '24033' prefix from census tract identification numbers and save the results in a new 'tract_number' column. 
pg_poverty_2020$tract_number <- gsub('24033', '', pg_poverty_2020$GEOID)
```

Lastly, we will use the ACS API to pull the median reported home value from the 2016-2020 ACS at the tract level. This is an imperfect measure because it is self-reported, but given that we cannot afford to generate tract identification numbers for all properties listed in the Prince George's County real estate assessment value dataset, it is the second-best approximation of home value available to us.

```{r}
md_homevalue_2020 <- get_acs(geography = "tract", state="MD",
  variables = c(homevalue_2020 = "B25107_001E"), year = 2020)

# Use the str_detect function and the string "Prince George" to isolate tracts in Prince George's County.
pg_homevalue_2020 <- md_homevalue_2020[str_detect(md_homevalue_2020$NAME, "Prince George"), ]

# Use the gsub function to remove the '24033' prefix from census tract identification numbers and save the results in a new 'tract_number' column. 
pg_homevalue_2020$tract_number <- gsub('24033', '', pg_homevalue_2020$GEOID)
```

At last, we can begin joining the ACS data to our core dataset. 


We start by joining the core dataset with the data on median household income by tract:

```{r}
# Left join the 2006-2010 ACS median household income data from the ACS with the pg_foreclosures_per_tract dataset.
pg_foreclosures_per_tract <- left_join(pg_medhouseholdincome_2010_tract, pg_foreclosures_per_tract, by=c("tract_number")) |>
  #Rename the "estimate" variable
  rename(tract_medincome_2010 = estimate) |>
  #Remove extraneous columns.
  select(-NAME, -variable, -GEOID.y) 
```

```{r}
# Left join the 2011-2015 ACS median household income data from the ACS with the pg_foreclosures_per_tract dataset.
pg_foreclosures_per_tract <- left_join(pg_medhouseholdincome_2015_tract, pg_foreclosures_per_tract, by=c("tract_number")) |>
  #Rename the "estimate" variable
  rename(tract_medincome_2015 = estimate) |>
  #Remove extraneous columns.
  select(-NAME, -variable, -GEOID.x) 
```

```{r}
# Left join the 2016-2020 ACS median household income data from the ACS with the pg_foreclosures_per_tract dataset.
pg_foreclosures_per_tract <- left_join(pg_medhouseholdincome_2020_tract, pg_foreclosures_per_tract, by=c("tract_number")) |>
  #Rename the "estimate" variable
  rename(tract_medincome_2020 = estimate) |>
  #Remove extraneous columns.
  select(-NAME, -variable) 
```


We join the core dataset with the data on the number of housing units per tract:

```{r}
# Left join the 2006-2010 ACS median household income data from the ACS with the pg_foreclosures_per_tract dataset.
pg_foreclosures_per_tract <- left_join(pg_total_housing_2010, pg_foreclosures_per_tract, by=c("tract_number")) |>
  #Rename the "estimate" variable
  rename(tract_housingunits_2010 = estimate) |>
  #Remove extraneous columns.
  select(-NAME, -variable) 
```

```{r}
# Left join the 2006-2010 ACS median household income data from the ACS with the pg_foreclosures_per_tract dataset.
pg_foreclosures_per_tract <- left_join(pg_total_housing_2015, pg_foreclosures_per_tract, by=c("tract_number")) |>
  #Rename the "estimate" variable
  rename(tract_housingunits_2015 = estimate) |>
  #Remove extraneous columns.
  select(-NAME, -variable) 
```

```{r}
# Left join the 2006-2010 ACS median household income data from the ACS with the pg_foreclosures_per_tract dataset.
pg_foreclosures_per_tract <- left_join(pg_total_housing_2020, pg_foreclosures_per_tract, by=c("tract_number")) |>
  #Rename the "estimate" variable
  rename(tract_housingunits_2020 = estimate) |>
  #Remove extraneous columns.
  select(-NAME, -variable) 
```

We join the core dataset with the data on the number of owner-occupied housing units per tract:

```{r}
# Left join the 2006-2010 ACS median household income data from the ACS with the pg_foreclosures_per_tract dataset.
pg_foreclosures_per_tract <- left_join(pg_owner_housing_2010, pg_foreclosures_per_tract, by=c("tract_number")) |>
  #Rename the "estimate" variable
  rename(tract_owneroccupied_2010 = estimate) |>
  #Remove extraneous columns.
  select(-NAME, -variable) 
```

```{r}
# Left join the 2011-2015 ACS median household income data from the ACS with the pg_foreclosures_per_tract dataset.
pg_foreclosures_per_tract <- left_join(pg_owner_housing_2015, pg_foreclosures_per_tract, by=c("tract_number")) |>
  #Rename the "estimate" variable
  rename(tract_owneroccupied_2015 = estimate) |>
  #Remove extraneous columns.
  select(-NAME, -variable) 
```

```{r}
# Left join the 2016-2020 ACS median household income data from the ACS with the pg_foreclosures_per_tract dataset.
pg_foreclosures_per_tract <- left_join(pg_owner_housing_2020, pg_foreclosures_per_tract, by=c("tract_number")) |>
  #Rename the "estimate" variable
  rename(tract_owneroccupied_2020 = estimate) |>
  #Remove extraneous columns.
  select(-NAME, -variable) 
```

We join the core dataset with the data on the number of mortgaged housing units per tract:

```{r}
# Left join the 2006-2010 ACS median household income data from the ACS with the pg_foreclosures_per_tract dataset.
pg_foreclosures_per_tract <- left_join(pg_debt_housing_2010, pg_foreclosures_per_tract, by=c("tract_number")) |>
  #Rename the "estimate" variable
  rename(tract_mortgaged_2010 = estimate) |>
  #Remove extraneous columns.
  select(-NAME, -variable) 
```

```{r}
# Left join the 2011-2015 ACS median household income data from the ACS with the pg_foreclosures_per_tract dataset.
pg_foreclosures_per_tract <- left_join(pg_debt_housing_2015, pg_foreclosures_per_tract, by=c("tract_number")) |>
  #Rename the "estimate" variable
  rename(tract_mortgaged_2015 = estimate) |>
  #Remove extraneous columns.
  select(-NAME, -variable) 
```

```{r}
# Left join the 2016-2020 ACS median household income data from the ACS with the pg_foreclosures_per_tract dataset.
pg_foreclosures_per_tract <- left_join(pg_debt_housing_2020, pg_foreclosures_per_tract, by=c("tract_number")) |>
  #Rename the "estimate" variable
  rename(tract_mortgaged_2020 = estimate) |>
  #Remove extraneous columns.
  select(-NAME, -variable) 
```

We join the core dataset with the data on the median age of residents by tract:

```{r}
# Left join the 2006-2010 ACS median household income data from the ACS with the pg_foreclosures_per_tract dataset.
pg_foreclosures_per_tract <- left_join(pg_medage_2020, pg_foreclosures_per_tract, by=c("tract_number")) |>
  #Rename the "estimate" variable
  rename(tract_medage_2020 = estimate) |>
  #Remove extraneous columns.
  select(-NAME, -variable) 
```

We join the core dataset with the data on the number of residents identified as non-Hispanic white per tract:

```{r}
# Left join the 2006-2010 ACS median household income data from the ACS with the pg_foreclosures_per_tract dataset.
pg_foreclosures_per_tract <- left_join(pg_nhwhite_2010, pg_foreclosures_per_tract, by=c("tract_number")) |>
  #Rename the "estimate" variable
  rename(tract_nhwhite_2010 = estimate) |>
  #Remove extraneous columns.
  select(-NAME, -variable) 
```

```{r}
# Left join the 2011-2015 ACS median household income data from the ACS with the pg_foreclosures_per_tract dataset.
pg_foreclosures_per_tract <- left_join(pg_nhwhite_2020, pg_foreclosures_per_tract, by=c("tract_number")) |>
  #Rename the "estimate" variable
  rename(tract_nhwhite2020 = estimate) |>
  #Remove extraneous columns.
  select(-NAME, -variable) 
```


We join the core dataset with the data on the number of residents (age >5) with an income below the poverty level in the previous 12 months:

```{r}
# Left join the 2006-2010 ACS median household income data from the ACS with the pg_foreclosures_per_tract dataset.
pg_foreclosures_per_tract <- left_join(pg_poverty_2010, pg_foreclosures_per_tract, by=c("tract_number")) |>
  #Rename the "estimate" variable
  rename(tract_poverty_2010 = estimate) |>
  #Remove extraneous columns.
  select(-NAME, -variable) 
```

```{r}
# Left join the 2011-2015 ACS median household income data from the ACS with the pg_foreclosures_per_tract dataset.
pg_foreclosures_per_tract <- left_join(pg_poverty_2020, pg_foreclosures_per_tract, by=c("tract_number")) |>
  #Rename the "estimate" variable
  rename(tract_poverty_2020 = estimate) |>
  #Remove extraneous columns, taking the opportunity to clear the extraneous columns that have accumulated during the joining process. 
  select(-NAME, -variable, -GEOID.x.x.x.x.x.x.x.x, -moe.x.x.x.x.x.x.x.x.x, -GEOID.y, -moe.y, -GEOID.x.x.x.x.x.x.x, -moe.x.x.x.x.x.x.x.x, - GEOID.y.y, -moe.y.y, -GEOID.x.x.x.x.x.x, -moe.x.x.x.x.x.x.x, -GEOID.y.y.y, -moe.y.y.y, -GEOID.x.x.x.x.x, -moe.x.x.x.x.x.x, -GEOID.y.y.y.y, -moe.y.y.y.y, -GEOID.x.x.x.x, -moe.x.x.x.x.x, -GEOID.y.y.y.y.y, -moe.y.y.y.y.y, -GEOID.x, -moe.x.x.x.x, -GEOID.y.y.y.y.y.y, -moe.y.y.y.y.y.y, -GEOID.x.x.x, -moe.x.x.x, -GEOID.y.y.y.y.y.y.y, -moe.y.y.y.y.y.y.y, -GEOID.x.x, -moe.x.x, -GEOID.y.y.y.y.y.y.y.y, -moe.y.y.y.y.y.y.y.y, -moe.x) 
```

We join the core dataset with the data on the median reported value of homes in a given tract from the 2016-2020 ACS:

```{r}
# Left join the 2006-2010 ACS median household income data from the ACS with the pg_foreclosures_per_tract dataset.
pg_foreclosures_per_tract <- left_join(pg_homevalue_2020, pg_foreclosures_per_tract, by=c("tract_number")) |>
  #Rename the "estimate" variable
  rename(tract_homevalue_2020 = estimate) |>
  #Remove extraneous columns.
  select(-NAME, -variable) 
```

Outside of this markdown, one of our team members created a spreadsheet containing the number of units built in each decade from 1940 to 1920, with columns for units built before 1939 and after 2020, and the average number of bedrooms per house. 

We will read that .csv file in and append it to the core dataset after adjusting the new dataframe's "tract" column to match the "tract_number" column in the pg_foreclosures_by_tract dataset.


```{r}
#Read in the geocoded construction year and median bedroom number dataset. 

pg_yr_bd_avg_tract <- read_csv("datasets/pg_yr_bd_avg_tract.csv", guess_max = 214) |>
  clean_names()
```
We use the gsub() and substr() functions to extract tract numbers from strings in the "tract" column of the new dataset.

```{r}
# Extract the digits from the strings in the "tract" column of the pg_yr_bd_avg_tract dataset
pg_yr_bd_avg_tract$tract_number <- gsub("[^0-9]", "", pg_yr_bd_avg_tract$tract)

# Extract the first four digits followed by the two digits after the period
pg_yr_bd_avg_tract$tract_number <- substr(pg_yr_bd_avg_tract$tract_number, 1, 6)

# Showing the updated dataframe
print(pg_yr_bd_avg_tract)
```

```{r}
# Left join the 2006-2010 ACS median household income data from the ACS with the pg_foreclosures_per_tract dataset.
pg_foreclosures_per_tract <- left_join(pg_yr_bd_avg_tract, pg_foreclosures_per_tract, by=c("tract_number")) |>
  #Remove extraneous columns.
  select(-GEOID, -moe, -moe.y.y.y.y.y.y.y.y.y, -avg_year_built_number, -avg_year_built, -tract) 
```

Finally, because our dependent variable is foreclosures per capita based on the 2016-2020 ACS population estimates, we can filter out dataset to exclude rows with missing values in the foreclosure_pc_2020 column. 

```{r}
pg_foreclosures_per_tract <- pg_foreclosures_per_tract[!is.na(pg_foreclosures_per_tract$foreclosure_pc_2020), ]
```

The last filter pares our dataset down to 173 rows -- still over the 100-tract threshold, but close enough that we will need to be mindful when creating test sets. 

To visualize the distribution of our dependent variable and identify possible outliers, we can plot a histogram of foreclosure rates per 1,000 residents for each remaining census tract in our dataset.

```{r}
hist(pg_foreclosures_per_tract$foreclosure_pc_2020, 
     main = "Distribution of per capita foreclosure rates by census tract",
     xlab = "Foreclosures per 1,000 residents at the census tract level",
     ylab = "Frequency")
```

